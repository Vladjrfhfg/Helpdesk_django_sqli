{% extends "helpdesk/base.html" %}

{% block title %}–£—è–∑–≤–∏–º—ã–π –ø–æ–∏—Å–∫{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="alert alert-danger">
        <h4>‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –£–Ø–ó–í–ò–ú–´–ô –ü–û–ò–°–ö</h4>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–º–µ—Ä–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è CVE. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ production!</p>
    </div>

    <h1 class="mb-4">üîì –£—è–∑–≤–∏–º—ã–π –ø–æ–∏—Å–∫ —Ç–∏–∫–µ—Ç–æ–≤</h1>
    
    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">–ü–æ–ª–µ (field):</label>
                    <input type="text" name="field" class="form-control" 
                           value="{{ field }}" placeholder="title, owner__username, etc.">
                </div>
                <div class="col-md-3">
                    <label class="form-label">–¢–∏–ø –ø–æ–∏—Å–∫–∞ (lookup):</label>
                    <input type="text" name="lookup" class="form-control" 
                           value="{{ lookup }}" placeholder="icontains, exact, gt, etc.">
                </div>
                <div class="col-md-3">
                    <label class="form-label">–ó–Ω–∞—á–µ–Ω–∏–µ (value):</label>
                    <input type="text" name="value" class="form-control" 
                           value="{{ value }}" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞">
                </div>
                <div class="col-md-3">
                    <label class="form-label">–õ–æ–≥–∏–∫–∞ (conn):</label>
                    <select name="conn" class="form-select">
                        <option value="AND" {% if conn == "AND" %}selected{% endif %}>AND</option>
                        <option value="OR" {% if conn == "OR" %}selected{% endif %}>OR</option>
                        <option value="NOT" {% if conn == "NOT" %}selected{% endif %}>NOT</option>
                    </select>
                </div>
                
                <div class="col-12 mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="extreme" 
                               value="1" id="extreme" {% if request.GET.extreme == '1' %}checked{% endif %}>
                        <label class="form-check-label text-danger" for="extreme">
                            ‚ö† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø–∞—Å–Ω—ã–π JSON —Ñ–∏–ª—å—Ç—Ä
                        </label>
                    </div>
                </div>
                
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">–ò—Å–∫–∞—Ç—å</button>
                    <a href="{% url 'helpdesk:vulnerable_search' %}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- JSON —Ñ–∏–ª—å—Ç—Ä (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω) -->
    {% if request.GET.extreme == '1' %}
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">‚ö† –û–ü–ê–°–ù–´–ô JSON –§–ò–õ–¨–¢–†</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">JSON –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞:</label>
                <textarea name="filter" class="form-control font-monospace" rows="4" 
                          placeholder='{"title__contains": "test", "status": "OPEN"}'
                          oninput="updateJSONFilter(this.value)"></textarea>
                <small class="text-muted">–í–≤–µ–¥–∏—Ç–µ JSON –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞. –û–ü–ê–°–ù–û!</small>
            </div>
            <button class="btn btn-danger" onclick="applyJSONFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å JSON —Ñ–∏–ª—å—Ç—Ä</button>
        </div>
    </div>
    {% endif %}
    
    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0">–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
        </div>
        <div class="card-body">
            <p><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:</strong></p>
            <ul>
                <li><code>field</code>: {{ field }}</li>
                <li><code>lookup</code>: {{ lookup }}</li>
                <li><code>value</code>: {{ value }}</li>
                <li><code>conn</code>: {{ conn }}</li>
                <li><code>extreme</code>: {{ request.GET.extreme|default:"0" }}</li>
            </ul>
            
            {% if query %}
            <p><strong>–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:</strong> {{ query }}</p>
            {% endif %}
            
            <p><strong>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ:</strong> <code>{{ field }}__{{ lookup }} = "{{ value }}"</code></p>
            
            {% if request.GET.extreme == '1' and request.GET.filter %}
            <p><strong>JSON —Ñ–∏–ª—å—Ç—Ä:</strong> <code>{{ request.GET.filter }}</code></p>
            {% endif %}
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <h3 class="mb-3">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: {{ tickets.count }} —Ç–∏–∫–µ—Ç–æ–≤</h3>
    
    {% if tickets %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>–ö–æ–¥</th>
                    <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                    <th>–ê–≥–µ–Ω—Ç</th>
                    <th>–°–æ–∑–¥–∞–Ω</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                <tr>
                    <td>
                        <a href="{% url 'helpdesk:ticket_detail' ticket.created.year ticket.created.month ticket.created.day ticket.code %}">
                            {{ ticket.code }}
                        </a>
                    </td>
                    <td>{{ ticket.title }}</td>
                    <td><span class="badge bg-info">{{ ticket.category }}</span></td>
                    <td>
                        <span class="badge {% if ticket.priority >= 8 %}bg-danger{% elif ticket.priority >= 5 %}bg-warning{% else %}bg-success{% endif %}">
                            {{ ticket.priority }}
                        </span>
                    </td>
                    <td>
                        <span class="badge {% if ticket.status == 'OPEN' %}bg-danger{% elif ticket.status == 'WAITING' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ ticket.status }}
                        </span>
                    </td>
                    <td>{{ ticket.owner.username }}</td>
                    <td>
                        {% if ticket.agent %}
                            {{ ticket.agent.username }}
                        {% else %}
                            <span class="text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>{{ ticket.created|date:"d.m.Y H:i" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <p class="mb-0">–¢–∏–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.</p>
    </div>
    {% endif %}
    
    <!-- –ü—Ä–∏–º–µ—Ä—ã —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤ -->
    <div class="card mt-4 border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">üìö –ü—Ä–∏–º–µ—Ä—ã —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>1. –ù–∞—Ä—É—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞:</h6>
                    <code class="d-block mb-2">?conn=OR</code>
                    <small>–ú–µ–Ω—è–µ—Ç AND –Ω–∞ OR - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤—Å–µ —Ç–∏–∫–µ—Ç—ã</small>
                    
                    <h6 class="mt-3">2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –∞–¥–º–∏–Ω–∞:</h6>
                    <code class="d-block mb-2">?field=owner__username&lookup=exact&value=admin</code>
                    <small>–ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–∏–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è admin</small>
                </div>
                <div class="col-md-6">
                    <h6>3. JSON –∏–Ω—ä–µ–∫—Ü–∏—è:</h6>
                    <code class="d-block mb-2">?extreme=1&filter={"owner__username":"admin","priority__gt":8}</code>
                    <small>–ü—Ä—è–º–æ–π —Ñ–∏–ª—å—Ç—Ä —á–µ—Ä–µ–∑ JSON</small>
                    
                    <h6 class="mt-3">4. –ò–Ω–≤–µ—Ä—Å–∏—è –ª–æ–≥–∏–∫–∏:</h6>
                    <code class="d-block mb-2">?conn=NOT</code>
                    <small>–ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –∑–∞–ø—Ä–æ—Å–∞</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateJSONFilter(value) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON –≤ localStorage –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    localStorage.setItem('jsonFilter', value);
}

function applyJSONFilter() {
    const jsonValue = document.querySelector('textarea[name="filter"]').value;
    const currentUrl = new URL(window.location.href);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    currentUrl.searchParams.set('extreme', '1');
    currentUrl.searchParams.set('filter', encodeURIComponent(jsonValue));
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–º—É URL
    window.location.href = currentUrl.toString();
}

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º JSON –∏–∑ localStorage
document.addEventListener('DOMContentLoaded', function() {
    const savedFilter = localStorage.getItem('jsonFilter');
    if (savedFilter) {
        const textarea = document.querySelector('textarea[name="filter"]');
        if (textarea) {
            textarea.value = savedFilter;
        }
    }
});
</script>
{% endblock %}
